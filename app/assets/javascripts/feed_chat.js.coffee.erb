add_message = (data) ->
  size = $('div.panel.fav#box-' + data.hashtag + ' .panel-body').length

  if size >= 5
    $('div.panel.fav#box-' + data.hashtag + ' .panel-body.fav:first').remove()

  hashtag_name = $('td a#' + data.hashtag).text()
  timestamp = moment.utc(data.timestamp).local().format('MMM D, H:mm');

  $('#feed').prepend ''+
    '<div class="feed-chat-box">' + 
      '<a href="/users/' + data.user + '" class="avatar-link">' +
        '<img class="img-circle" src="' + data.avatar + '"></img>' +
      '</a>' +
      '<div class="message">' +
        '<h5>' +
          '<a href="/users/' + data.user + '">' + data.username + '</a>at ' +
          '<a href="/hashtags/' + data.hashtag + '">' + hashtag_name + '</a>' +
          '<span class="timestamp">' + timestamp + '</span>' +
        '</h5>' +
        '<p>' + data.content + '</p>' +
      '</div>' +
    '</div>'

  $('div.panel.fav#box-' + data.hashtag).append ''+
    '<div class="panel-body fav">' + 
      '<div class="favourites-chat-box">' +
        '<div class="message">' + 
          '<p>' +
            '<a href="/users/' + data.user + '" class="user">' + data.username + '</a> ' +
            data.content +
            '<br><span>' + timestamp + '</span>' +
          '</p>' +
        '</div>' +
      '</div>' +
    '</div>'

  $('#masonry-container').masonry()
  
ready = ->
  if not $('#feed').length
    return

  scheme = <%= ENV['RAILS_ENV'] == "production" ? '"wss://"' : '"ws://"' %>
  host = <%= ENV['RAILS_ENV'] == "test" ? '"echo.websocket.org/"' : 'window.document.location.host' %>
  uri = scheme + host
  ws = new WebSocket(uri)

  user = $('#user-id')[0].value

  ws.onopen = ->
    ws.send JSON.stringify
      event: 'feed'
      user: user

  ws.onmessage = (message) ->
    data = JSON.parse message.data
    
    if data.event == 'message'
      add_message data
    else if data.event == 'notification'
      t = Number($('.notif-count').text())
      $('.notif-count').text(t + 1)
      if t == 0
        $('.notif-icon').css('color', '#FFDB00');
        $('.notif-count').css('color', '#FFDB00');

$(document).ready(ready)
$(document).on('page:load', ready)
